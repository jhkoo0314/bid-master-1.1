# BidMaster v1.2 – 전체 엔진 재설계 사양서

> **업데이트 유형:** Major (v1.1 → v1.2)
> **적용 범위:** 매물 생성 엔진 / 권리·비용 계산 / 시세 모델 / MoS 로직 / 전체 분석 파이프라인
> **핵심 변화:** 감정가 기반 구조 → ✅ "시장가(FMV) 기준 역산 구조"로 변경
> **적용 모드:** 개발모드(dummy), 프로덕션(OpenAI) 모두 동일하게 적용

---

## 1. 변경 배경

기존 엔진은 `감정가(appraisalValue)`를 기준으로 매물이 생성되었으며, 시세(FMV), 낙찰가, 권리금, 비용 등이 이후 단계에서 파생되었다. 이 구조는 다음과 같은 문제를 유발했다:

| 문제 현상 | 원인 |
|-----------|------|
| ✅ 모든 매물이 안전마진(MoS) 음수 | 감정가 < FMV 구조가 아님 → 시세가 감정가 이하로 생성됨 |
| ✅ 권리금·비용 비정상 과대 | 생성 시 밸런스 검증 부재 |
| ✅ AI 생성 모드에서도 동일 문제 발생 | 후처리 없는 JSON 파싱 방식 |
| ✅ MoS가 결과가 아니라 "항상 음수인 구조적 상태" | 계산식이 아니라 입력값 왜곡 때문 |

이에 따라 **v1.2부터 매물 생성 기준을 감정가 중심이 아닌 → ✅ 시장가(FMV) 중심 구조로 전환**한다.

---

## 2. 핵심 구조 변경 요약

| 항목 | 기존 구조 (v1.1) | 신규 구조 (v1.2) |
|-------|------------------|------------------|
| 생성 기준 | 감정가 → 시세 파생 | ✅ 시세(FMV) → 감정가·최저가 역산 |
| 시세 모델 | 감정가 × 계수 | ✅ FMV = Normal(μ=1.00, σ=0.08) 분포 |
| 권리금 | 감정가 40~70% 등 비현실 값 발생 | ✅ FMV × (0~35%) 현실 분포 적용 |
| 입찰가(B) | 감정가 × 0.7~0.9 등 고정 | ✅ FMV × (0.60~0.95) 완전 랜덤 분포 |
| 비용 (세금·수리·명도) | 고정값 또는 과대 | ✅ 낙찰가/건물연식 기반 랜덤 모델 적용 |
| MoS 설계 | 계산만 수행, 생성단계 통제 없음 | ✅ 생성단계에서 데이터 sanity pass 후 저장 |
| AI 생성 | OpenAI JSON 그대로 사용 | ✅ 후처리 sanitizeScenario() 강제 적용 |

---

## 3. 생성 규칙 사양 (v1.2 기준)

### ✅ 3.1 FMV 생성 (시세)
```
FMV = RandomNormal(mean = basePrice, sd = 8%)
하한: basePrice × 0.85
상한: basePrice × 1.25
```
- basePrice는 지역/유형/면적을 고려한 내부 기준값 (추후 확장)

### ✅ 3.2 감정가 역산
```
appraisalValue = FMV × Random(0.82 ~ 0.97)
```
- 현실 감정가 특성: 일반적으로 시세 대비 3~18% 낮음

### ✅ 3.3 최저가(입찰 시작가)
```
minimumBidPrice = appraisalValue × 0.7
→ 보정: 반올림(만원 단위)
```

### ✅ 3.4 예상낙찰가(B)
```
B = FMV × Random(0.60 ~ 0.95)
```
- 시장조건/경쟁률에 따라 유동 값 생성

### ✅ 3.5 권리 인수비용(R)
```
Tier 1 (무권리)    0% ~ 3%   (확률 25%)
Tier 2 (일반)      3% ~ 12%  (확률 55%)
Tier 3 (고위험)   12% ~ 35% (확률 20%)
```
- 기준 값: FMV × 비율

### ✅ 3.6 취득세(T)
```
if (주거용)   1.1% ~ 3.5%
else          4.0% ~ 4.6%
```

### ✅ 3.7 수리비(C)
```
건물연식 < 10년 → 0원 ~ 200만원
10~25년 → 200만원 ~ 1500만원
25년 이상 → 500만원 ~ 2500만원
```

### ✅ 3.8 명도비(E)
```
점유자 없음 → 0
점유자 있음 → 300만원 ~ 1200만원
```

---

## 4. 분석 파이프라인 변경 (v1.2 기준)

### ✅ 기존 구조
```
생성 → 상세페이지 진입 → 권리분석 → 비용계산 → 시세비교 → MoS → 수익률 분석
```

### ✅ 신규 구조
```
[매물 생성 자체에서 값 sanity check] ✅
↓
저장/표시 (MoS 예상 가능 상태)
↓
상세 분석 페이지에서 정식 계산 + 리포트
```

✅ 즉: "생성된 시점부터 이미 학습 가능한 상태"가 되어야 함.

---

## 5. 신규 함수 목록

| 함수 | 역할 | 적용 위치 |
|--------|------|-------------|
| `generateFMV()` | 시장가 생성 | openai-client.ts |
| `generateAppraisalFromFMV()` | 감정가 역산 | openai-client.ts |
| `generateRightsCost()` | 권리 인수 비용 생성 | openai-client.ts |
| `generateAcquisitionCosts()` | 세금/명도/수리/예비비 생성 | openai-client.ts |
| `sanitizeScenario()` | AI 응답 후처리 & 값 정상화 | openai-client.ts |

---

## 6. MoS 예상 분포 목표 (v1.2)

| 구분 | 목표 비율 |
|-------|------------|
| 양수 MoS (>0) | 35% ~ 50% |
| 중립 (-5% ~ 0) | 15% ~ 25% |
| 음수 (≤ -5%) | 30% ~ 45% |

> 목표는 "성공/실패/위험매물 혼합" 상태 유지 (학습형 시뮬레이터 기준)

---

## 7. 적용 우선순위

```
[1] openai-client.ts 생성 엔진 전면 교체
[2] rights-analysis-engine.ts 입력값 스펙 맞춰 조정
[3] auction-cost.ts / safety-calc.ts 내부 검증
[4] profit-calculator.ts 수익률 계산 검증
[5] 100개 샘플 생성 → 분포 로그 확인
```

---

## 8. 테스트 체크리스트 (v1.2)

✅ 100개 생성 테스트 → MoS 양수/음수 분포 확인
✅ FMV / 감정가 / 최저가 / 낙찰가 관계 정상 여부
✅ 총인수금액(A) < FMV 물건이 30% 이상 존재하는지 확인
✅ AI 생성 모드에서도 동일한 결과 보장 (sanitizeScenario 적용)

---

## 9. 다음 단계

1. `openai-client.ts` 패치 생성 (Cursor 적용용 diff 발행)
2. 테스트 스크립트 `run-simulation-batch.ts` 생성
3. v1.2 UI 변경 spec 작성 (MoS 표시 방식 포함)

---

## ✅ 결론

BidMaster v1.2 업데이트는 **"계산 로직 수정"이 아니라 "시장 기반 데이터 생성으로 구조 자체를 정상화"하는 대규모 업데이트**이다.

이제부터 매물 생성 → 분석 → 수익 예측 → 시뮬레이션 단계가 **현실 경매 시장과 동일한 흐름으로 동작**한다.

다음 단계: `openai-client.ts` Cursor 패치 생성 준비됨.

